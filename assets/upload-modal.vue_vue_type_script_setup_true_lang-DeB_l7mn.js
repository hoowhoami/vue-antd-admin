import{f as y}from"./dateUtil-D7gJQxXe.js";import{V as S,A as k}from"./index-BGRhdYbt.js";import{ar as R,bu as O,U as f,K as F,e as D,ae as P,aI as T,Y as L}from"./antdv-BbttoKUq.js";import{k as s,G as m,d as N,f as C,c as z,W as B,a5 as G,Y as p,u as w,F as $,ac as V}from"./vue-nPfkdNmw.js";import{_ as j}from"./index.vue_vue_type_style_index_0_lang-PCrZZ9h2.js";import{u as K}from"./dynamic-table-3ORtHQM3.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-BEJgt-SP.js";let o=function(e){return e.SUCCESS="success",e.ERROR="error",e.UPLOADING="uploading",e}({});const Z=[{title:"文件名",dataIndex:"name",width:150,ellipsis:!0,customRender({record:e}){return s(F,null,{title:()=>e.path,default:()=>s("a",{href:S+e.path,target:"_blank"},[e.name])})}},{title:"预览图",dataIndex:"path",width:150,customRender({record:e}){return s(R,{src:S+e.path},null)}},{title:"文件后缀",dataIndex:"extName",width:80},{title:"类别",dataIndex:"type",width:80},{title:"大小",dataIndex:"size",width:80,customRender:({record:e})=>s(f,{color:"blue"},{default:()=>[e.size]})},{title:"上传者",dataIndex:"username",width:120},{title:"创建时间",dataIndex:"createdAt",width:160,customRender:({record:e})=>y(e.createdAt)}],M=[{dataIndex:"thumbUrl",title:"缩略图",width:100,customRender:({record:e})=>{const{thumbUrl:r}=e;return r&&s(R,{src:r},null)}},{dataIndex:"name",title:"文件名",align:"left",customRender:({text:e,record:r})=>{const{percent:_,status:d}=r||{};let l="normal";return d===o.ERROR?l="exception":d===o.UPLOADING?l="active":d===o.SUCCESS&&(l="success"),s("div",null,[s("p",{class:"truncate mb-1 max-w-[280px]",title:e},[e]),s(O,{percent:_,size:"small",status:l},null)])}},{dataIndex:"size",title:"文件大小",width:100,customRender:({text:e=0})=>e&&`${(e/1024).toFixed(2)}KB`},{dataIndex:"status",title:"状态",width:100,customRender:({text:e})=>e===o.SUCCESS?s(f,{color:"green"},{default:()=>[m("上传成功")]}):e===o.ERROR?s(f,{color:"red"},{default:()=>[m("上传失败")]}):e===o.UPLOADING?s(f,{color:"blue"},{default:()=>[m("上传中")]}):e||"待上传"}],ee=[{field:"name",label:"名称",component:"Input",colProps:{span:8}}],te=N({__name:"upload-modal",emits:["uploadSuccess"],setup(e,{emit:r}){const _=r,[d]=K(),l=C(!1),u=C([]),U=z(()=>!u.value.some(a=>a.status!==o.SUCCESS)),I=a=>{const{promise:t,resolve:n,reject:c}=Promise.withResolvers(),i=new FileReader;return i.onload=()=>{n(i.result)},i.onerror=h=>{c(h)},i.readAsDataURL(a),t},v=()=>{u.value.some(t=>t.status===o.SUCCESS)&&_("uploadSuccess"),u.value=[]},x=async()=>{const a=u.value.filter(t=>t.status!==o.SUCCESS);await Promise.all(a.map(async t=>{try{await k.toolsUpload.uploadUpload({file:t.file},void 0,{onUploadProgress(n){const c=n.loaded/n.total*100|0;t.percent=c,t.status=o.UPLOADING}}),t.status=o.SUCCESS}catch(n){t.status=o.ERROR}}))},E=async a=>{if(a.size/1024/1024>2)D.error("单个文件不超过2MB");else{const t={file:a,uid:a.uid,name:a.name,size:a.size,status:"",percent:0,thumbUrl:await I(a)};u.value.push(t)}return!1},g=a=>{u.value=u.value.filter(t=>t.uid!==a.uid)},A=[...M,{width:120,title:"操作",dataIndex:"ACTION",fixed:!1,actions:({record:a})=>[{label:"删除",color:"red",onClick:()=>g(a)}]}];return(a,t)=>{const n=V("a-button"),c=P,i=T,h=L;return B(),G($,null,[s(n,{type:"primary",disabled:!a.$auth("upload:upload"),onClick:t[0]||(t[0]=b=>l.value=!0)},{default:p(()=>[m(" 上传 ")]),_:1},8,["disabled"]),s(w(j),{open:l.value,"onUpdate:open":t[1]||(t[1]=b=>l.value=b),title:"上传",width:800,"ok-text":"开始上传","ok-button-props":{disabled:U.value},onOk:x,onCancel:v},{default:p(()=>[s(h,{justify:"space-between",align:"center"},{default:p(()=>[s(c,{message:"单个文件不超过2MB，最多只能上传10个文件",type:"info","show-icon":""}),s(i,{multiple:!0,"before-upload":E,"show-upload-list":!1},{default:p(()=>[s(n,{type:"primary"},{default:p(()=>[m(" 选择文件 ")]),_:1})]),_:1})]),_:1}),s(w(d),{search:!1,"data-source":u.value,columns:A},null,8,["data-source"])]),_:1},8,["open","ok-button-props"])],64)}}});export{te as _,Z as b,ee as s};
