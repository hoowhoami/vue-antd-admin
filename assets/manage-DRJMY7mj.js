import{I as P,A as $,n as q}from"./index-BGRhdYbt.js";import{_ as Q,g as Z}from"./file-operate-button-list.vue_vue_type_script_setup_true_lang-BtnOtSfR.js";import{_ as ee}from"./file-preview-drawer.vue_vue_type_script_setup_true_lang-DvQvfswe.js";import{f as ae,p as te}from"./index-5akZo7rI.js";import{f as ne}from"./dateUtil-D7gJQxXe.js";import{aN as f,a0 as H,br as le,$ as I,bs as S,ac as se}from"./antdv-BbttoKUq.js";import{f as r,c as x,k as l,ac as oe,d as ie,r as ue,w as re,o as me,W as d,X as N,Y as i,u as n,G as O,a5 as F,ae as ce,F as fe,H as pe,ak as U,ad as de}from"./vue-nPfkdNmw.js";import"./index.vue_vue_type_style_index_0_lang-PCrZZ9h2.js";import{u as ve}from"./useFormModal-Rxxc5YaB.js";import{c as he}from"./createContextMenu-C4sBosg6.js";import{u as ge}from"./dynamic-table-3ORtHQM3.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-BEJgt-SP.js";import"./file-upload-drawer.vue_vue_type_script_setup_true_lang-DF0Jymup.js";import"./is-DIFaXsjl.js";import"./useModal-CiZQoqSP.js";import"./schema-form.vue_vue_type_script_setup_true_lang-ChTuMCM5.js";const ye=c=>c?ae(c):"-",ke=()=>{const c=r([]),v=r(""),k=x(()=>!f(v.value)),T=x(()=>[{title:"文件名",dataIndex:"name",align:"left"},{title:"大小",width:120,align:"center",dataIndex:"fsize",customRender:({record:a})=>l("span",null,[ye(a.fsize)])},{title:"上传时间",dataIndex:"putTime",align:"center",width:220,customRender({text:a}){return a?ne(a):"-"}},{title:"所属目录",dataIndex:"belongTo",align:"center",width:220,hideInTable:!k.value,customRender:({record:a})=>l(oe("a-button"),{type:"link",disabled:a.type==="file"&&P("netdisk:manage:info"),onClick:()=>C(a)},{default:()=>[a.belongTo?a.belongTo:"根目录"]})}]),C=a=>{v.value="",f(a.belongTo)?c.value=[]:c.value=a.belongTo.split("/")};return{columns:T,currentPathList:c,localSearchKey:v,isSearching:k}},be=["innerHTML"],_e={key:1},ze=ie({name:"NetDiskManage",__name:"manage",setup(c){const[v,k]=ge(),[T]=ve(),{columns:C,currentPathList:a,localSearchKey:m,isSearching:b}=ke(),w=r(),h=r([]),g=r(""),K=r(!1),D=r(!1),B=r(!1),p=r(!1),M=r([]),z=ue({selectedRowKeys:[],onChange:(e,t)=>{z.selectedRowKeys=e,M.value=t.map(u=>({type:u.type,name:u.name}))}}),V=x(()=>f(g.value)),y=()=>{let e="";return a.value.length>0&&(e=`${a.value.join("/")}/`),e},A=(e,t)=>t==="dir"?"file-type-dir":te(e),W=e=>e.replace(new RegExp(`${m.value}`,"g"),`<span style='color: red;'>${m.value}</span>`),j=e=>{K.value!==e&&(K.value=e)},L=()=>{g.value=" ",h.value=[],M.value=[],p.value&&(p.value=!1),R()},R=async()=>{var u;if(p.value,p.value)return;D.value=!0,p.value=!0;const e=y(),t=await $.netDiskManage.netDiskManageList({path:e,key:m.value,marker:((u=g.value)==null?void 0:u.trim())||""}).finally(()=>D.value=!1);if(f(g))h.value=t.list||[];else{const s=t.list.filter(o=>o.type==="file"?!0:!h.value.find(_=>_.type==="file"?!1:_.name===o.name));f(s)||h.value.push(...s)}g.value=t.marker,p.value=!1},E=e=>{b.value||(e===-1&&a.value.length>0?a.value=[]:e>=0&&a.value.length-1!==e&&(a.value=a.value.slice(0,e+1)))},G=e=>{var t,u;if(e.type==="dir")if(b.value){const s=f(e.belongTo)?[]:e.belongTo.split("/");s.push(e.name),m.value="",a.value=s}else a.value.push(e.name);else b.value?(t=w.value)==null||t.open(e.name,f(e.belongTo)?"":`${e.belongTo}/`):(u=w.value)==null||u.open(e.name,y())},J=async e=>{try{B.value=!0;const t=await $.netDiskManage.netDiskManageDownload({path:y(),name:e.name});window.open(`${t}?attname=${encodeURIComponent(e.name)}`)}finally{B.value=!1}},X=async e=>{await T({modalProps:{title:"重命名",width:700,onFinish:async t=>{await $.netDiskManage.netDiskManageRename({type:e.type,toName:t.toName,name:e.name,path:y()},{successMsg:"修改成功"}),L()}},formProps:{labelWidth:100,schemas:Z(e)}})},Y=e=>({onContextmenu:t=>{he({event:t,items:[{label:"下载",disabled:e.type==="dir"||!P("netdisk:manage:download"),handler:()=>{J(e)}},{label:"重命名",disabled:!P("netdisk:manage:rename"),handler:()=>{X(e)}}]})}});return re([a,m],()=>{L()},{deep:!0}),me(()=>{R(),k.onInfiniteScroll(()=>{V.value||R()})}),(e,t)=>{const u=q;return d(),N(n(se),{class:"h-full"},{title:i(()=>[l(n(H),null,{default:i(()=>[l(n(le)),l(n(I),null,{default:i(()=>[l(n(I).Item,null,{default:i(()=>[l(n(S).Link,{onClick:t[0]||(t[0]=s=>E(-1))},{default:i(()=>[O("根目录")]),_:1})]),_:1}),(d(!0),F(fe,null,ce(n(a),(s,o)=>(d(),N(n(I).Item,{key:o},{default:i(()=>[l(n(S).Link,{onClick:_=>E(o)},{default:i(()=>[O(U(s),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),extra:i(()=>[l(Q,{"search-key":n(m),"onUpdate:searchKey":t[1]||(t[1]=s=>pe(m)?m.value=s:null),"selected-file-list":M.value,"update-operate-status":j,"parse-path":y,onChanged:L},null,8,["search-key","selected-file-list"])]),default:i(()=>[l(n(v),{"data-source":h.value,columns:n(C),"custom-row":Y,"auto-height":!0,pagination:!1,search:!1,"show-tool-bar":!1,loading:D.value,"row-selection":z},{bodyCell:i(({column:s,record:o})=>[s.key==="name"?(d(),N(n(S).Link,{key:0,disabled:o.type==="file"&&e.$auth("netdisk:manage:info"),onClick:_=>G(o)},{default:i(()=>[l(n(H),null,{default:i(()=>[l(u,{name:A(o.name,o.type)},null,8,["name"]),n(b)?(d(),F("span",{key:0,innerHTML:W(o.name)},null,8,be)):(d(),F("span",_e,U(o.name),1))]),_:2},1024)]),_:2},1032,["disabled","onClick"])):de("",!0)]),_:1},8,["data-source","columns","loading","row-selection"]),l(ee,{ref_key:"previewDrawerRef",ref:w},null,512)]),_:1})}}});export{ze as default};
